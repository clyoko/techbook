# Git进阶与团队协作

>**HyperQing** 2016-05-10

[TOC]

## 背景

随着开发工作越来越多人参与，参与开发的人员基本上都会使用Git进行版本管理和协作，但是使用效果不尽人意，有时还会带来严重的麻烦，甚至是毁灭性的代码丢失……为此，有必要结合团队实际开发经验来讲解Git进阶内容。

## 仓库与缓存

本地仓库、暂存区和远程仓库的概念

+ `项目文件夹`即工作区
+ `项目文件夹/.git`即版本库，版本库又包括了暂存区和分支

此处所述为讲解`git stash`命令做铺垫。

具体参考资料：[工作区和暂存区-廖雪峰](http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/0013745374151782eb658c5a5ca454eaa451661275886c6000)

## 分支管理艺术

文章[《GIT分支管理是一门艺术》](http://kb.cnblogs.com/page/132209/)指出，要妥善地管理分支，就需要多种分支协同工作。在此，结合团队开发经验和实际使用情况，提出以下几类分支：

>注：实际分支命名和用途以团队协作规范为准，本节指出的命名和用途仅供参考，不作为强制使用的依据，其他章节同。

- master：**主分支**。成员可**随时**在该分支获得**最新发布**的版本，用于**最终生产环境部署**。
- release：**预发布分支**。这是适应项目需求而提出来的分支，用于**预发布机上进行线上测试**。
- dev：**开发分支**。成员可**随时**在该分支获得**最新开发进度**的版本。
- feature：**新功能开发分支或特性分支**，用于**新功能或新特性开发探索**，该分支最终会被**合并到dev分支（探索成功的情况）**或**直接删除（探索失败的情况）**。
- hotfix：**补丁分支**。dev分支一段长时间的开发未完成，而线上版本master或release出现bug时，**为了不打乱dev分支开发进程**，于是**在dev分支过去某个发布时间点新建hotfix分支进行修复**。随后hotfix合并到release测试和master**发布后成功修复bug时，删除hotfix补丁分支**。**此过程不会牵涉到正在开发的dev，但要记得将补丁hotfix合并一份到dev中。**
- 其他特殊用途分支。例如**临时分支补救大法**（后文进行解释）中的**临时分支**。

## Git Flow 工作流（分支合并方向）

忽略掉各种软件开发模型，无非就是四步：

**设计->编码->测试->发布**

于是我们也不难得出分支的合并方向：

**开发分支->预发布分支->主分支**

即

**dev->release->master**

在我们的实践中，开发必须遵循这个合并方向，意味着**所有代码修改只能在dev或其他用于开发的分支上进行！**

理由有一下几点：

- 上述几个分支运行在不同环境，配置文件是不同的，往同一个方向合并，不会使配置文件重复覆盖，可以不改半点代码即可部署。但是，方向一旦错乱，配置文件互相地错误地覆盖，会导致分支拉取下来后无法在指定环境中运行（配置文件已经错乱了）。
- 始终修改dev或其他开发分支，能在合并时令其他不直接修改的分支保持同步。如果直接在服务器修改代码然后提交，再合并回dev，这中间就会发生差错，至少是配置文件出现差错。
- 有利于保持dev是最新的开发进度。

在我们团队中，禁止成员在预发布分支和主分支上推送（push）代码。只允许合并。

## 团队协作和代码贡献

>**沟通！沟通！沟通！**

一般情况下，Git进行代码合并（Merge）时是顺利完成的。

而现在合并冲突发生最多的情况是：*两个或以上的成员修改同一份文件*。

我想大家都应该知道要怎么做了：*主动通知可能要修改该文件的人员，避免同时修改同一份文件*。


>**团队协作开发中，每个人都将贡献代码。但不是所有贡献的代码都会被保留到最终产品中。这是团队协作的前提。**

要想在最终产品中尽可能保留你的代码

- 写出更优秀的代码
- 说服主管采用你的方案
- 主动与其他成员交流，完善自己的代码
- 很好的解决需求，完成相关设计
- 其他有利于保留贡献代码的行动

以上，将促使成员更努力地学习，写出更好的代码。

## 临时分支大法

## 命令行操作

Git GUI：图形化界面。操作简单直观，部分Git命令可能无法操作。
Git Bash：命令行界面。需要理解记忆命令，可进行Git所有命令。

后面的章节将使用Git Bash进行操作。

## 获取与推送

- **拉取更新**
```
$ git pull <远程主机名> <远程分支名>:<本地分支名>
```
```
// 从远程仓库origin获取和合并所有分支更新
$ git pull origin
// 从远程仓库origin获取和合并指定分支更新
$ git push origin master:master
```

- **设置关联分支**

PHPStorm等IDE支持一键更新项目，这需要设置本地分支与远程分支的关联对应关系。
下列语句表示，本地的master分支关联对应远程的origin/master分支。

```
git branch --set-upstream master origin/master
```
【更新】上面这句被提示不赞成使用并将被移除，故换成下面这句。
```
git branch --set-upstream-to origin/master
```
删除已存在的关联，如果操作未关联的分支，将会报错`fatal: Branch 'master' has no upstream information`
```
git branch --unset-upstream master
git branch --unset-upstream origin/master
```

- **推送更新**
```
$ git push <远程主机名> <本地分支名>:<远程分支名>
```
```
// 推送所有提交到远程仓库origin
$ git push origin
// 推送指定分支到远程仓库origin
$ git push origin master:master
```
- 获取与合并
```
// 假设当前已在dev分支
$ git fetch origin
$ git merge origin/dev
```

## reset（重置分支指针）
```
$ git reset --hard <commit>
```
```
// 撤销未提交(commit)的更改
$ git reset --hard HEAD
// 重置分支指针到242a9c8b
$ git reset --hard 242a9c8b
```

## revert(推错代码补救)
```
$ git revert <commit>
```

## stash（储藏，暂存工作区代码）
```
$ git stash
```


## tag和checkout（标签与签出实现版本切换）
```
$ git tag <tagname>
```
```
$ git checkout <branch/tag>
```

## rebase（重新定义起点）
```
$ git rebase <branch>
```
```
// 假设当前已在master分支
// 将dev分支的内容整合到master分支上
$ git checkout master
$ git rebase dev
```
```
// 垃圾回收
$ git gc
```