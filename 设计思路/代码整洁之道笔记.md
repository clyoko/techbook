# 代码整洁之道笔记

by HyperQing 2018-08-11

[TOC]

## 命名

**要点**

- 名副其实：见名知意，既不会有多余的意思，也不会有未说清的内容。
- 避免误导：名称可能带有类型后缀，不要乱编后缀。
- 可口语朗读：避免奇怪的缩写或自造词。
- 可搜索的名称：应该为数字常量赋予一个方便搜索的常量名称。
- 驼峰法变量名一般地无需加上类型后缀。
- 没必要加上`m_`成员前缀。
- 接口起名不应该在前面加个`I`。
- 名副其实
- 避免思维映射：讲的应该是使用缩写不要让人慢慢猜，你不知道别人是怎么猜的。
- 类名应当是名词或名词短语。
- 方法名应当是动词或动词短语，可以使用`get`,`set`,`save`,`is`,`has`之类的前缀。
- 言到意到，意到言到，别乱起傻傻的名字。
- 每个概念对应一个词，避免一个概念使用多个近义词。
- 避免双关语，同一个方法名完成截然不同的任务。
- 如果有问题领域术语，尽量将其转为技术术语，实在搞不定就只能保留领域术语了。
- 添加合适的语境，`name`含糊不清，`userName`就很好了。
- 不要加没用的语境，比如每个类都加一个项目名前缀，很傻。

**心得**

相比过去，当用心将一个忽视命名的代码，改成重视命名的，仅仅是阅读一下就感受到这段代码相当地**可维护**，**可理解**。因为一目了然，不会对变量的含义或作用产生困惑。用《点石成金》（UI交互类）一书标题来说，就是**“Don‘t make me think”**。其他工程师都是我这段代码的用户，应该重视代码用户体验。前后端代码质量是浑然一体不可分割的。

**提示**
- 如果你的变量用途复杂，无法取一个简单易懂的名称，尝试将变量用途拆解。
- 如何学习起名？多看优秀项目的代码。
- “我的变量好像真是无法变得更简单”，这有可能是类和方法封装不到位引起的。
- “这是一个好的命名吗”，问问你的同事，或者一周后再来阅读自己的代码，连自己都费解的，可以改名了。
- 由于历史遗留原因，改名务必咨询同事、检查调用之处，改名后进行严谨的测试，确保没有留下后遗症。

## 函数

**要点**

- 短小，人们要理解一段长函数是非常困难的，难以记住各种调用的参数和返回值，一旦经过合理封装后，函数内容一目了然。
- 一个函数只做一件事，想想我们熟悉的MVC框架就懂了。
- 每个函数一个抽象层级，例如控制器中写一大堆具体的正则匹配操作就不合理了，应该封装为一个参数过滤方法，控制器不关心底层细节。
- Swtich语句的出现，如果每个case都是返回一个实例对象，有可能需要使用工厂模式。
- 函数名称不怕长，风格要保持一致，好的命名甚至可以不写注释。
- 函数的参数越少越好，如果某几个参数是有关联的，例如X坐标值和Y坐标值，那就应该封装一个Coordinate坐标类来传参。
- 参数很多的，可以考虑将形参名写到函数名中。
- 无副作用，书中举出一个例子，检查密码的方法里会有session操作，这很不好，应该返回`true`或`false`由外部调用去操作session。
- `getter`和`setter`的功能应该不同，例如`set($data)`有返回值，究竟是返回已设置的`$data`还是未设置的`$data`，还是`bool`值。现在生产上为了能够链式调用`setter`，几乎都是固定返回`$this`。
- `Try/Catch`中的代码一应当简单，不应写一大堆底层算法。
- DRY原则（Don't repeat yourself，不要重复自己的代码）。有重复？是时候要封装了。
- 结构化编程（if/else/break/contine/while等）时，函数保持短小，可以免除一大堆多余的结构语句。

**心得**

以前：

一个函数过百行，虽然调试时不需要进入函数，也方便随时修改。但经常会有前两三行改了，后面几十行都要全部改一次的问题。典型的没面向输出输入编程。

现在：

封装后，主逻辑可能稍长，但每个子方法只有简单几行，非常容易理解和检查算法是否正确，且可独立测试。某方法修改时，不影响其他方法，保证进出参数相同类型即可。

准确、简短、易懂的代码富有生命力，至少不会再像以前一样在代码堆中感到窒息和手足无措。

## 注释

**要点**

- 如果一段代码要很长的注释来解释，先优化你的代码，更好的命名或更有力的封装。
- 法律、版权、业务逻辑、意外之处、复杂算法的中间结果、警告、还有TODO等注释都可以在生产中使用。
- 废话、没什么用的、过时的、错误的注释应及时清理，写了错误的注释，不如不写。
- 能用命名表达意思的，可省略注释，前提是表达准确。
- 被注释的代码，实践中几乎都不会再重新使用，删了吧。除了单元测试中为了方便切换测试条件的注释，不过，这种情况更应该考虑写多个不同的测试用例，而不是靠注释切换。
- 合理书写类的作用，但不宜太具体描述算法，因为注释经常忘记更新，简单描述一下类的用途就够了。当然，如果复杂到说不清，拆分类再试吧。

**心得**

注释的多少，很大程度取决于代码是否合理拆分和封装，命名是否掷地有声。代码太糟糕的，多少注释都说不清。

## 格式

- 对PHP程序员来说，使用PSR相关格式化规范即可，PHPStorm的格式化已经自动帮你格式化了。

## 对象和数据结构

- 合理抽象和具象。
- 数据结构和行为是对立的，过程代码难以添加新数据结构，对象代码难以添加新函数。
- 德墨忒尔律：模块不应该了解它所操作对象的内部情形。
- 数据传送对象，只有数据结构定义，没有函数的类，即诸多ORM中的Entity类概念。

**心得**

结合ORM、Repository模式、依赖注入、数据操作便捷性等各个方面来理解，Entity或Scheme类这种数据结构类，其实只是一个框架大架构的基本设计。换言之，单独讨论对象和数据结构的问题，难以理解其必要性。

## 错误处理

- 使用异常而非使用返回码。
- 依调用者需要去定义异常类。 

**心得**

缺少、过度、泛滥的异常都是不可取的。一段代码可能会有多个潜在异常，实际上真正要抛出来的是，是调用者期望的异常，而不是自己想象的。

## 边界

- 自行封装三方库，避免直接使用三方库，当三方库更换时，才不会令整个系统重构。
- 使用不存在的代码。解耦划分模块开发时，做好边界约定。

**心得**

尤其是使用冷门，不太靠谱的三方库时，更不应该在系统中充斥着调用代码，一旦更新换代，损失惨重。可以参考适配器（Adapter）模式。

## 单元测试

TDD三定律
 1. 在编写不能通过的单元测试前，不可编写生产代码。
 2. 只可编写刚好无法通过的单元测试。
 3. 只可编写刚好足以通过当前失败测试的生产代码。
 
总的来说就是先写测试再写生产代码，写一个测试就应该立即写它的实现代码。

整洁的测试遵循5条原则F.I.R.S.T
1. 快速：执行快速，随手测试。
2. 独立：多个测试之间避免互相依赖。
3. 可重复：任何环境均能重复通过测试。
4. 自足验证：单元测试结果即最终结果，而不是去查看日志或检查数据库。
5. 及时：测试应及时编写，尽量在写生产代码前写好，这个前提下写出来的生产代码才是可供测试的。

**心得**

TDD方式开发项目，尤其是涉及算法、监控、高可靠的项目，大有裨益。如果担心编写测试是否浪费时间，倒不如担心一下，不写测试排查问题要花多少时间。另一方面，在团队开发过程中，任何一个成员都有可能引入一些破坏性操作，例如增减配置、改名、重构等。如果能够立即跑一次单元测试，确认操作无误，简直是一件极其美好的事情。

## 类

- 封装
- 单一职责原则，碰到完成非常多任务的类，是时候拆分了
- 保持内聚会得到许多短小的类
- 对扩展开放，对修改闭合，添加功能避免对原有的类进行修改。
- 若有经常修改类的需要，应当谨慎考虑组织好类。

**心得**

如果需要频繁修改类，参考诸多ORM是如何提供扩展功能的。

## 系统

- 将系统的构造和使用分开，这是两个非常不同的过程。
- 分解主函数。
- 抽象工厂，用于构造各种对象。
- 依赖注入（DI）和控制反转（IoC）。
- 面向切面编程（AoP）。

**心得**

观察MVC框架，大多都有个Bootstrap类或简单粗暴的Start类，亦或是bootKerbel()方法。

## 迭进（迭代？）

要使设计变得简单的规则：

- 运行所有测试，容易测试的系统，也意味着容易维护。
- 不可重复，模板方法模式是一种移除高层级重复的通用技巧。
- 表达了程序员的意图，强调表达力，代码应如诗如画。
- 尽可能减少类和方法数量。

以上规则按其重要程度排列。

**心得**

敏捷开发的其中一条原则：以简洁为本，它是极力减少不必要工作量的艺术。

## 其他章节

- 并发编程
- 逐步改进
- JUint内幕
- 重构SerialDate
- 味道与启发